
let 
    (* EXPORT START *)
    fun send_delay (to, m) delay =
        sleep delay;
        send (to, m)

    fun send_n_updates raft n =
        let fun loop n =
            send(raft, ("RAFT-UPDATE", ("TEST", "TEST")));
            print n;
            sleep 10;
            if n > 1 then loop (n - 1) else () 
        in loop n 
    end

    fun send_n_unique_updates raft n =
        let fun loop n =
            send(raft, ("RAFT-UPDATE", (mkuuid(), "TEST")));
            print n;
            sleep 10;
            if n > 1 then loop (n - 1) else ()
        in loop n
    end

    fun test1_local () = 
        let val raft = key_val_store_init raft true
        in
            send(raft, ("SEND-TO-NTH", 1, "debug-timeout"));
            send_delay(raft, ("RAFT-UPDATE", ("Hello", "There"))) 500;
            send_delay(raft, ("SEND-TO-NTH", 1, "debug-pause")) 1000;
            print "killing I";
            send_delay(raft, ("RAFT-UPDATE", ("Hello", "World"))) 500;
            send_delay(raft, ("SEND-TO-NTH", 1, "debug-continue")) 8000;
            print "reviving I";
            send(raft, ("SEND-TO-NTH", 1, ("RAFT-UPDATE", ("Hello", "Other World"))));
            send_delay(raft, ("SEND-TO-ALL", "debug-printlog")) 2000
    end

    fun test2_local () = 
        let val raft = key_val_store_init raft true
        in 
            send(raft, ("SEND-TO-NTH", 1, "debug-timeout"));
            send(raft, ("SEND-TO-NTH", 2, "debug-timeout"));
            send_delay(raft, ("SEND-TO-ALL", "debug-printlog")) 1000
    end

    fun test3_local () = 
        let val p_id = self()
            val raft = key_val_store_init raft true
        in 
            send_delay(raft, ("RAFT-UPDATE", ("A", 42))) 2000;
            send_delay(raft, ("RAFT-GET", ("A", p_id))) 1000;
            receive [hn x => print x]
    end

    fun test4_local () = 
        let val raft = key_val_store_init raft true
        in
            send_delay(raft, ("RAFT-UPDATE", ("Hello", "There"))) 2000;
            send_delay(raft, ("RAFT-UPDATE", ("Hello", "There"))) 1000;
            send_delay(raft, ("RAFT-UPDATE", ("Hello", "There"))) 1000;
            send_delay(raft, ("RAFT-UPDATE", ("Hello", "There"))) 1000;
            send_delay(raft, ("RAFT-UPDATE", ("Hello", "There"))) 1000;
            send_delay(raft, ("SEND-TO-ALL", "debug-printlog")) 4000
    end

    fun test5_local () =
        let val raft = key_val_store_init raft true
        in
            send(raft, ("SEND-TO-NTH", 1, "debug-timeout"));
            send_n_updates raft 5;
            send(raft, ("SEND-TO-NTH", 1, "debug-snapshotcond"))
    end

    fun test6_local () = 
        let val raft = key_val_store_init raft true
        in
            send(raft, ("SEND-TO-NTH", 1, "debug-timeout"));
            send_delay(raft, ("SEND-TO-NTH", 1, ("RAFT-UPDATE", ("B", 1)))) 2000;
            send_delay(raft, ("SEND-TO-NTH", 1, ("RAFT-UPDATE", ("A", 1)))) 2000;
            send_delay(raft, ("SEND-TO-NTH", 1, ("RAFT-UPDATE", ("A", 1)))) 0;
            send_delay(raft, ("SEND-TO-NTH", 1, ("RAFT-UPDATE", ("A", 1)))) 0;
            send_delay(raft, ("SEND-TO-NTH", 3, "debug-timeout")) 10;
            send_delay(raft, ("SEND-TO-ALL", "debug-printlog")) 5000
    end

    fun test7_local () = 
        let val raft = key_val_store_init raft true 
        in 
            send(raft, ("SEND-TO-NTH", 1, "debug-timeout"));
            send_delay(raft, ("RAFT-UPDATE", ("A", 2))) 1000;
            send_delay(raft, ("RAFT-UPDATE", ("A", 3))) 500;
            send_delay(raft, ("RAFT-UPDATE", ("A", 4))) 10;
            send_delay(raft, ("SEND-TO-ALL", "debug-printlog")) 5000
    end

    fun test_snapshot () =
        let val raft = key_val_store_init raft true
        in 
            send(raft, ("SEND-TO-NTH", 1, "debug-timeout"));
            send_delay(raft, ("SEND-TO-NTH", 3, "debug-pause")) 100;
            send(raft, ("RAFT-UPDATE", ("A", 1)));
            send_delay(raft, ("RAFT-UPDATE", ("A", 2))) 50;
            send_delay(raft, ("RAFT-UPDATE", ("A", 4))) 50;
            send_delay(raft, ("SEND-TO-NTH", 1, "debug-applysnapshot")) 100;
            send_delay(raft, ("SEND-TO-NTH", 3, "debug-continue")) 100;
            send_delay(raft, ("SEND-TO-ALL", "debug-printlog")) 500
    end

    fun test_lots_of_messages () = 
        let val raft = key_val_store_init raft true 
        in 
            send(raft, ("SEND-TO-NTH", 1, "debug-timeout"));
            sleep 1000;
            send_n_updates raft 1000;
            send_delay(raft, ("SEND-TO-ALL", "debug-printlog")) 5000
    end

    fun test_lots_of_unique_messages () = 
        let val raft = key_val_store_init raft true
        in
            sleep 5000;
            send_n_unique_updates raft 5;
            send_delay(raft, ("SEND-TO-ALL", "debug-printlog")) 1000
    end

    fun test1_dist () = 
        let val raft = key_val_store_init raft_d true
            val p_id = self()
        in
            print raft;
            send_delay (raft, ("RAFT-UPDATE", ("A", 42))) 2000;
            send_delay (raft, ("RAFT-GET", ("A", p_id))) 2000;
            receive [hn x => print x]
    end
    (* EXPORT END *)